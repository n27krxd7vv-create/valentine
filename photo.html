<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Valentine | Fotka</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-deep: #0f0c1d; --accent: #ff2d75; --glass: rgba(255, 255, 255, 0.07); --glass-border: rgba(255, 255, 255, 0.15); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Inter', sans-serif; background: radial-gradient(circle at center, #1e1333 0%, #0f0c1d 100%); color: white; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        .bg-elements { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .glass-card { z-index: 10; background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 35px; padding: 30px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); width: 85%; max-width: 400px; text-align: center; animation: fadeIn 1s ease-out; }
        
        /* Upload z칩na */
        .photo-frame {
            aspect-ratio: 4/5; border: 2px solid var(--glass-border); border-radius: 25px;
            overflow: hidden; position: relative; background: rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        /* Tla캜칤tko pro nahr치n칤 (Vid칤 jen tv콢rce) */
        .upload-ui { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; width: 100%; height: 100%; justify-content: center; }
        .upload-ui:hover { background: rgba(255,255,255,0.05); }
        .icon { font-size: 40px; margin-bottom: 10px; opacity: 0.8; }
        .hint { font-size: 14px; opacity: 0.6; }

        h1 { margin: 10px 0 20px 0; font-size: 24px; color: var(--accent); }

        .btn-continue {
            margin-top: 20px; width: 100%; padding: 15px; border-radius: 50px; border: none;
            background: linear-gradient(90deg, #ff2d75, #bc26b7); color: white; font-weight: bold; font-size: 16px;
            cursor: pointer; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .btn-continue.visible { opacity: 1; pointer-events: auto; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .flying-away { animation: flyAway 1s forwards; }
        @keyframes flyAway { to { transform: translateY(-100vh) scale(0.8); opacity: 0; } }
    </style>
</head>
<body>

    <div class="bg-elements"></div>

    <div class="glass-card" id="card">
        <h1 id="title-text">Vzpom칤nka...</h1>
        
        <div class="photo-frame" id="photo-container">
            <img id="preview-img">
            
            <div class="upload-ui" id="upload-btn" onclick="document.getElementById('file-input').click()">
                <div class="icon">游닞</div>
                <div class="hint">Klikni a nahraj fotku</div>
            </div>
            
            <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFile(this)">
        </div>

        <button class="btn-continue" id="next-btn" onclick="goNext()">Pokra캜ovat 仇벒잺</button>
    </div>

    <script>
        // === KL칈캛E ===
        const SUPABASE_URL = 'https://ebqqfbacsgskoueoaugc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicXFmYmFjc2dza291ZW9hdWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODMyMzQsImV4cCI6MjA4MzQ1OTIzNH0.Zv5o1o48BW5GXNyh17DGuicSjjrLkW8L9beuHHkhQjU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const valentineId = urlParams.get('id');
        const nextBtn = document.getElementById('next-btn');

        // 1. ZJISTIT RE콯IM (Tv콢rce vs. P콏칤jemce)
        window.addEventListener('load', async () => {
            if (valentineId) {
                // --- RE콯IM P콎칈JEMCE (M치 ID) ---
                document.getElementById('upload-btn').style.display = 'none'; // Schovat upload
                document.getElementById('title-text').innerText = "Vzpom칤n치코?";
                
                // St치hnout fotku
                const { data } = await supabase.from('valentines').select('photo_url').eq('id', valentineId).single();
                if (data && data.photo_url) {
                    const img = document.getElementById('preview-img');
                    img.src = data.photo_url;
                    img.style.display = 'block';
                    setTimeout(() => nextBtn.classList.add('visible'), 1000); // Tla캜칤tko se uk치쬰 po chvilce
                }
            } else {
                // --- RE콯IM TV콡RCE (Nem치 ID) ---
                document.getElementById('title-text').innerText = "Vyber va코i fotku";
                // Upload tla캜칤tko je vid캩t defaultn캩
                
                // Pokud u n캩co nahr치l v minul칠m kroku (kdyby se vr치til), na캜teme to
                const savedImg = localStorage.getItem('preview_image_base64');
                if (savedImg) {
                    showPreview(savedImg);
                }
            }
        });

        // Funkce pro nahr치n칤 fotky (Tv콢rce)
        function handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;
                    // Ulo쬴t do do캜asn칠 pam캩ti pro Checkout
                    localStorage.setItem('preview_image_base64', base64);
                    showPreview(base64);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showPreview(src) {
            const img = document.getElementById('preview-img');
            img.src = src;
            img.style.display = 'block';
            document.getElementById('upload-btn').style.display = 'none';
            nextBtn.classList.add('visible');
        }

        function goNext() {
            document.getElementById('card').classList.add('flying-away');
            setTimeout(() => {
                // Pokud m치me ID, pos칤l치me ho d치l. Pokud ne, jdeme bez n캩j (re쬴m tvorby)
                if (valentineId) window.location.href = 'letter.html?id=' + valentineId;
                else window.location.href = 'letter.html';
            }, 800);
        }
    </script>
</body>
</html>
